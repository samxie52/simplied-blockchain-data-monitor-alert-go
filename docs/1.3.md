# Step 1.3: æ—¥å¿—å’Œç›‘æ§åŸºç¡€

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**åŠŸèƒ½**: å»ºç«‹æ—¥å¿—è®°å½•å’ŒåŸºç¡€ç›‘æ§  
**ç›®æ ‡**: å®ç°ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿå’Œ Prometheus ç›‘æ§æŒ‡æ ‡æ”¶é›†ï¼Œä¸ºåº”ç”¨ç¨‹åºæä¾›å®Œå–„çš„å¯è§‚æµ‹æ€§åŸºç¡€

## ğŸ¯ å®ç°ç›®æ ‡

1. âœ… å®ç°ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨ (pkg/logger/logger.go)
2. âœ… é›†æˆ Prometheus æŒ‡æ ‡æ”¶é›† (pkg/metrics/prometheus.go)
3. âœ… æ·»åŠ åŸºç¡€ä¸­é—´ä»¶ (internal/middleware/)

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ—¥å¿—å’Œç›‘æ§æ¶æ„
```
pkg/
â”œâ”€â”€ logger/
â”‚   â”œâ”€â”€ logger.go          # ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨
â”‚   â””â”€â”€ fields.go          # æ—¥å¿—å­—æ®µå®šä¹‰
â”œâ”€â”€ metrics/
â”‚   â”œâ”€â”€ prometheus.go      # Prometheus æŒ‡æ ‡å®šä¹‰
â”‚   â””â”€â”€ collector.go       # æŒ‡æ ‡æ”¶é›†å™¨
internal/middleware/
â”œâ”€â”€ logging.go             # æ—¥å¿—ä¸­é—´ä»¶
â”œâ”€â”€ metrics.go             # æŒ‡æ ‡ä¸­é—´ä»¶
â”œâ”€â”€ cors.go                # CORS ä¸­é—´ä»¶
â””â”€â”€ auth.go                # è®¤è¯ä¸­é—´ä»¶
```

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1: å®ç°ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨

#### 1.1 åˆ›å»º pkg/logger/logger.go
```go
package logger

import (
	"context"
	"fmt"
	"io"
	"os"
	"path/filepath"
	"time"

	"github.com/sirupsen/logrus"
)

// Logger ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨
type Logger struct {
	*logrus.Logger
	component string
}

// Config æ—¥å¿—é…ç½®
type Config struct {
	Level     string `json:"level"`
	Format    string `json:"format"`
	Output    string `json:"output"`
	FilePath  string `json:"file_path,omitempty"`
	Component string `json:"component"`
}

// New åˆ›å»ºæ–°çš„æ—¥å¿—è®°å½•å™¨
func New(config Config) (*Logger, error) {
	log := logrus.New()

	// è®¾ç½®æ—¥å¿—çº§åˆ«
	level, err := logrus.ParseLevel(config.Level)
	if err != nil {
		return nil, fmt.Errorf("invalid log level: %w", err)
	}
	log.SetLevel(level)

	// è®¾ç½®æ—¥å¿—æ ¼å¼
	switch config.Format {
	case "json":
		log.SetFormatter(&logrus.JSONFormatter{
			TimestampFormat: time.RFC3339,
		})
	case "text":
		log.SetFormatter(&logrus.TextFormatter{
			FullTimestamp:   true,
			TimestampFormat: time.RFC3339,
		})
	default:
		return nil, fmt.Errorf("unsupported log format: %s", config.Format)
	}

	// è®¾ç½®æ—¥å¿—è¾“å‡º
	output, err := getLogOutput(config.Output, config.FilePath)
	if err != nil {
		return nil, fmt.Errorf("failed to setup log output: %w", err)
	}
	log.SetOutput(output)

	return &Logger{
		Logger:    log,
		component: config.Component,
	}, nil
}

// getLogOutput è·å–æ—¥å¿—è¾“å‡º
func getLogOutput(output, filePath string) (io.Writer, error) {
	switch output {
	case "stdout":
		return os.Stdout, nil
	case "stderr":
		return os.Stderr, nil
	case "file":
		if filePath == "" {
			return nil, fmt.Errorf("file path is required when output is 'file'")
		}
		
		// ç¡®ä¿ç›®å½•å­˜åœ¨
		if err := os.MkdirAll(filepath.Dir(filePath), 0755); err != nil {
			return nil, fmt.Errorf("failed to create log directory: %w", err)
		}
		
		file, err := os.OpenFile(filePath, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)
		if err != nil {
			return nil, fmt.Errorf("failed to open log file: %w", err)
		}
		return file, nil
	default:
		return nil, fmt.Errorf("unsupported output type: %s", output)
	}
}

// WithContext æ·»åŠ ä¸Šä¸‹æ–‡
func (l *Logger) WithContext(ctx context.Context) *logrus.Entry {
	entry := l.Logger.WithContext(ctx).WithField("component", l.component)
	
	// ä»ä¸Šä¸‹æ–‡ä¸­æå–è¯·æ±‚ID
	if requestID := ctx.Value("request_id"); requestID != nil {
		entry = entry.WithField("request_id", requestID)
	}
	
	return entry
}

// LogHTTPRequest è®°å½•HTTPè¯·æ±‚æ—¥å¿—
func (l *Logger) LogHTTPRequest(method, path, userAgent, clientIP string, statusCode int, duration time.Duration) {
	l.WithFields(logrus.Fields{
		"method":      method,
		"path":        path,
		"user_agent":  userAgent,
		"client_ip":   clientIP,
		"status_code": statusCode,
		"duration_ms": duration.Milliseconds(),
		"type":        "http_request",
		"component":   l.component,
	}).Info("HTTP request processed")
}
```

### æ­¥éª¤ 2: å®ç° Prometheus æŒ‡æ ‡æ”¶é›†

#### 2.1 åˆ›å»º pkg/metrics/prometheus.go
```go
package metrics

import (
	"net/http"
	"strconv"
	"time"

	"github.com/prometheus/client_golang/prometheus"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)

// Metrics PrometheusæŒ‡æ ‡æ”¶é›†å™¨
type Metrics struct {
	// HTTPç›¸å…³æŒ‡æ ‡
	HTTPRequestsTotal     *prometheus.CounterVec
	HTTPRequestDuration   *prometheus.HistogramVec
	HTTPRequestsInFlight  prometheus.Gauge
	
	// æ•°æ®åº“ç›¸å…³æŒ‡æ ‡
	DatabaseConnectionsActive prometheus.Gauge
	DatabaseQueryDuration     *prometheus.HistogramVec
	DatabaseQueriesTotal      *prometheus.CounterVec
	
	// åŒºå—é“¾ç›¸å…³æŒ‡æ ‡
	BlockchainBlocksProcessed *prometheus.CounterVec
	BlockchainLatestBlock     prometheus.Gauge
	
	// å‘Šè­¦ç›¸å…³æŒ‡æ ‡
	AlertsTotal        *prometheus.CounterVec
	AlertsActive       prometheus.Gauge
	
	// ç³»ç»Ÿç›¸å…³æŒ‡æ ‡
	ApplicationInfo    *prometheus.GaugeVec
	ApplicationUptime  prometheus.Gauge
}

// NewMetrics åˆ›å»ºæ–°çš„æŒ‡æ ‡æ”¶é›†å™¨
func NewMetrics(namespace string) *Metrics {
	return &Metrics{
		HTTPRequestsTotal: prometheus.NewCounterVec(
			prometheus.CounterOpts{
				Namespace: namespace,
				Name:      "http_requests_total",
				Help:      "Total number of HTTP requests",
			},
			[]string{"method", "path", "status_code"},
		),
		HTTPRequestDuration: prometheus.NewHistogramVec(
			prometheus.HistogramOpts{
				Namespace: namespace,
				Name:      "http_request_duration_seconds",
				Help:      "HTTP request duration in seconds",
				Buckets:   prometheus.DefBuckets,
			},
			[]string{"method", "path"},
		),
		HTTPRequestsInFlight: prometheus.NewGauge(
			prometheus.GaugeOpts{
				Namespace: namespace,
				Name:      "http_requests_in_flight",
				Help:      "Number of HTTP requests currently being processed",
			},
		),
		DatabaseConnectionsActive: prometheus.NewGauge(
			prometheus.GaugeOpts{
				Namespace: namespace,
				Name:      "database_connections_active",
				Help:      "Number of active database connections",
			},
		),
		DatabaseQueryDuration: prometheus.NewHistogramVec(
			prometheus.HistogramOpts{
				Namespace: namespace,
				Name:      "database_query_duration_seconds",
				Help:      "Database query duration in seconds",
				Buckets:   []float64{0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1.0},
			},
			[]string{"operation", "table"},
		),
		DatabaseQueriesTotal: prometheus.NewCounterVec(
			prometheus.CounterOpts{
				Namespace: namespace,
				Name:      "database_queries_total",
				Help:      "Total number of database queries",
			},
			[]string{"operation", "table", "status"},
		),
		BlockchainBlocksProcessed: prometheus.NewCounterVec(
			prometheus.CounterOpts{
				Namespace: namespace,
				Name:      "blockchain_blocks_processed_total",
				Help:      "Total number of blockchain blocks processed",
			},
			[]string{"network"},
		),
		BlockchainLatestBlock: prometheus.NewGauge(
			prometheus.GaugeOpts{
				Namespace: namespace,
				Name:      "blockchain_latest_block_number",
				Help:      "Latest block number processed",
			},
		),
		AlertsTotal: prometheus.NewCounterVec(
			prometheus.CounterOpts{
				Namespace: namespace,
				Name:      "alerts_total",
				Help:      "Total number of alerts triggered",
			},
			[]string{"type", "severity"},
		),
		AlertsActive: prometheus.NewGauge(
			prometheus.GaugeOpts{
				Namespace: namespace,
				Name:      "alerts_active",
				Help:      "Number of active alerts",
			},
		),
		ApplicationInfo: prometheus.NewGaugeVec(
			prometheus.GaugeOpts{
				Namespace: namespace,
				Name:      "application_info",
				Help:      "Application information",
			},
			[]string{"version", "environment"},
		),
		ApplicationUptime: prometheus.NewGauge(
			prometheus.GaugeOpts{
				Namespace: namespace,
				Name:      "application_uptime_seconds",
				Help:      "Application uptime in seconds",
			},
		),
	}
}

// Register æ³¨å†Œæ‰€æœ‰æŒ‡æ ‡
func (m *Metrics) Register() error {
	collectors := []prometheus.Collector{
		m.HTTPRequestsTotal,
		m.HTTPRequestDuration,
		m.HTTPRequestsInFlight,
		m.DatabaseConnectionsActive,
		m.DatabaseQueryDuration,
		m.DatabaseQueriesTotal,
		m.BlockchainBlocksProcessed,
		m.BlockchainLatestBlock,
		m.AlertsTotal,
		m.AlertsActive,
		m.ApplicationInfo,
		m.ApplicationUptime,
	}
	
	for _, collector := range collectors {
		if err := prometheus.Register(collector); err != nil {
			return err
		}
	}
	
	return nil
}

// RecordHTTPRequest è®°å½•HTTPè¯·æ±‚æŒ‡æ ‡
func (m *Metrics) RecordHTTPRequest(method, path string, statusCode int, duration time.Duration) {
	m.HTTPRequestsTotal.WithLabelValues(method, path, strconv.Itoa(statusCode)).Inc()
	m.HTTPRequestDuration.WithLabelValues(method, path).Observe(duration.Seconds())
}

// Handler è¿”å›Prometheus HTTPå¤„ç†å™¨
func (m *Metrics) Handler() http.Handler {
	return promhttp.Handler()
}
```

### æ­¥éª¤ 3: å®ç°åŸºç¡€ä¸­é—´ä»¶

#### 3.1 åˆ›å»º internal/middleware/logging.go
```go
package middleware

import (
	"net/http"
	"time"

	"github.com/samxie52/simplied-blockchain-data-monitor-alert-go/pkg/logger"
)

// LoggingMiddleware æ—¥å¿—ä¸­é—´ä»¶
type LoggingMiddleware struct {
	logger *logger.Logger
}

// NewLoggingMiddleware åˆ›å»ºæ—¥å¿—ä¸­é—´ä»¶
func NewLoggingMiddleware(logger *logger.Logger) *LoggingMiddleware {
	return &LoggingMiddleware{
		logger: logger,
	}
}

// responseWriter åŒ…è£…å“åº”å†™å…¥å™¨ä»¥æ•è·çŠ¶æ€ç 
type responseWriter struct {
	http.ResponseWriter
	statusCode int
}

func (rw *responseWriter) WriteHeader(code int) {
	rw.statusCode = code
	rw.ResponseWriter.WriteHeader(code)
}

// Middleware æ—¥å¿—ä¸­é—´ä»¶å¤„ç†å‡½æ•°
func (m *LoggingMiddleware) Middleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		start := time.Now()
		
		// åŒ…è£…å“åº”å†™å…¥å™¨
		rw := &responseWriter{
			ResponseWriter: w,
			statusCode:     http.StatusOK,
		}
		
		// å¤„ç†è¯·æ±‚
		next.ServeHTTP(rw, r)
		
		// è®¡ç®—å¤„ç†æ—¶é—´
		duration := time.Since(start)
		
		// è®°å½•æ—¥å¿—
		m.logger.LogHTTPRequest(
			r.Method,
			r.URL.Path,
			r.UserAgent(),
			getClientIP(r),
			rw.statusCode,
			duration,
		)
	})
}

// getClientIP è·å–å®¢æˆ·ç«¯IPåœ°å€
func getClientIP(r *http.Request) string {
	if xff := r.Header.Get("X-Forwarded-For"); xff != "" {
		return xff
	}
	if xri := r.Header.Get("X-Real-IP"); xri != "" {
		return xri
	}
	return r.RemoteAddr
}
```

#### 3.2 åˆ›å»º internal/middleware/metrics.go
```go
package middleware

import (
	"net/http"
	"time"

	"github.com/samxie52/simplied-blockchain-data-monitor-alert-go/pkg/metrics"
)

// MetricsMiddleware æŒ‡æ ‡ä¸­é—´ä»¶
type MetricsMiddleware struct {
	metrics *metrics.Metrics
}

// NewMetricsMiddleware åˆ›å»ºæŒ‡æ ‡ä¸­é—´ä»¶
func NewMetricsMiddleware(metrics *metrics.Metrics) *MetricsMiddleware {
	return &MetricsMiddleware{
		metrics: metrics,
	}
}

// Middleware æŒ‡æ ‡ä¸­é—´ä»¶å¤„ç†å‡½æ•°
func (m *MetricsMiddleware) Middleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		start := time.Now()
		
		// å¢åŠ æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°
		m.metrics.HTTPRequestsInFlight.Inc()
		defer m.metrics.HTTPRequestsInFlight.Dec()
		
		// åŒ…è£…å“åº”å†™å…¥å™¨ä»¥æ•è·çŠ¶æ€ç 
		rw := &responseWriter{
			ResponseWriter: w,
			statusCode:     http.StatusOK,
		}
		
		// å¤„ç†è¯·æ±‚
		next.ServeHTTP(rw, r)
		
		// è®°å½•æŒ‡æ ‡
		duration := time.Since(start)
		m.metrics.RecordHTTPRequest(r.Method, r.URL.Path, rw.statusCode, duration)
	})
}
```

#### 3.3 åˆ›å»º internal/middleware/cors.go
```go
package middleware

import (
	"net/http"
	"strings"
)

// CORSMiddleware CORSä¸­é—´ä»¶
type CORSMiddleware struct {
	allowedOrigins []string
	allowedMethods []string
	allowedHeaders []string
}

// NewCORSMiddleware åˆ›å»ºCORSä¸­é—´ä»¶
func NewCORSMiddleware(allowedOrigins []string) *CORSMiddleware {
	return &CORSMiddleware{
		allowedOrigins: allowedOrigins,
		allowedMethods: []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
		allowedHeaders: []string{"Content-Type", "Authorization", "X-Requested-With"},
	}
}

// Middleware CORSä¸­é—´ä»¶å¤„ç†å‡½æ•°
func (m *CORSMiddleware) Middleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		origin := r.Header.Get("Origin")
		
		// æ£€æŸ¥æ˜¯å¦å…è®¸è¯¥æ¥æº
		if m.isAllowedOrigin(origin) {
			w.Header().Set("Access-Control-Allow-Origin", origin)
		}
		
		w.Header().Set("Access-Control-Allow-Methods", strings.Join(m.allowedMethods, ", "))
		w.Header().Set("Access-Control-Allow-Headers", strings.Join(m.allowedHeaders, ", "))
		w.Header().Set("Access-Control-Allow-Credentials", "true")
		
		// å¤„ç†é¢„æ£€è¯·æ±‚
		if r.Method == "OPTIONS" {
			w.WriteHeader(http.StatusOK)
			return
		}
		
		next.ServeHTTP(w, r)
	})
}

// isAllowedOrigin æ£€æŸ¥æ˜¯å¦å…è®¸è¯¥æ¥æº
func (m *CORSMiddleware) isAllowedOrigin(origin string) bool {
	for _, allowed := range m.allowedOrigins {
		if allowed == "*" || allowed == origin {
			return true
		}
	}
	return false
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### éªŒè¯æ­¥éª¤

1. **éªŒè¯æ—¥å¿—è®°å½•å™¨**
```bash
go run cmd/server/main.go
```

2. **éªŒè¯æŒ‡æ ‡æ”¶é›†**
```bash
curl http://localhost:9090/metrics
```

3. **è¿è¡Œå•å…ƒæµ‹è¯•**
```bash
make test-unit
```

## ğŸ“‹ å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨å®ç°å®Œæˆ
- [ ] PrometheusæŒ‡æ ‡æ”¶é›†å™¨å®ç°å®Œæˆ
- [ ] æ—¥å¿—ä¸­é—´ä»¶å®ç°å®Œæˆ
- [ ] æŒ‡æ ‡ä¸­é—´ä»¶å®ç°å®Œæˆ
- [ ] CORSä¸­é—´ä»¶å®ç°å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

å®Œæˆ Step 1.3 åï¼Œä¸‹ä¸€æ­¥å°†å®æ–½ **Step 1.4: æ•°æ®åº“è¿æ¥å±‚**ï¼ŒåŒ…æ‹¬ï¼š
- å®ç° PostgreSQL è¿æ¥ç®¡ç† (pkg/database/postgres.go)
- å®ç° Redis è¿æ¥ç®¡ç† (pkg/database/redis.go)
- æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥
- åˆ›å»ºæ•°æ®åº“è¿ç§»å·¥å…·

## ğŸ“ Git Commit ä¿¡æ¯

```bash
git add .
git commit -m "feat: add logging and basic monitoring infrastructure

- Implement structured logger with configurable output and format
- Add Prometheus metrics collection for HTTP, database, and blockchain
- Create logging middleware for HTTP request tracking
- Add metrics middleware for request monitoring
- Implement CORS middleware for cross-origin requests
- Support for contextual logging with request IDs
- Add comprehensive metrics for system observability

This provides a solid foundation for application monitoring
and debugging with structured logs and detailed metrics."
```

---

**çŠ¶æ€**: âœ… å‡†å¤‡å®æ–½  
**é¢„ä¼°æ—¶é—´**: 3-4 å°æ—¶  
**ä¾èµ–**: Step 1.2 å®Œæˆ  
**ä¸‹ä¸€æ­¥**: Step 1.4 æ•°æ®åº“è¿æ¥å±‚
