# Step 2.3: WebSocket Connection Management

## æ¦‚è¿°

Step 2.3 å®ç°äº†å®Œæ•´çš„WebSocketè¿æ¥ç®¡ç†å’Œå®æ—¶æ•°æ®è®¢é˜…ç³»ç»Ÿï¼Œä¸ºåŒºå—é“¾ç›‘æ§æä¾›å®æ—¶æ•°æ®æµå¤„ç†èƒ½åŠ›ã€‚

## å®ç°ç›®æ ‡

- âœ… WebSocketè¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… è®¢é˜…ç®¡ç†å’Œè‡ªåŠ¨é‡è¿æœºåˆ¶  
- âœ… äº‹ä»¶è¿‡æ»¤å’Œè·¯ç”±ç³»ç»Ÿ
- âœ… å®æ—¶åŒºå—è®¢é˜…æœåŠ¡
- âœ… å®æ—¶äº¤æ˜“è®¢é˜…æœåŠ¡
- âœ… è¿æ¥çŠ¶æ€ç›‘æ§å’Œç»Ÿè®¡

## æ ¸å¿ƒç»„ä»¶

### 1. WebSocket Connection Manager (`websocket.go`)

è´Ÿè´£ç»´æŠ¤ä¸ä»¥å¤ªåŠèŠ‚ç‚¹çš„WebSocketè¿æ¥ã€‚

**ä¸»è¦ç‰¹æ€§:**
- 5ç§è¿æ¥çŠ¶æ€ç®¡ç† (Disconnected, Connecting, Connected, Reconnecting, Closed)
- è‡ªåŠ¨é‡è¿æœºåˆ¶ (å¯é…ç½®é—´éš”å’Œæ¬¡æ•°)
- å¿ƒè·³æ£€æµ‹ (ping/pong)
- åŒå‘æ¶ˆæ¯é˜Ÿåˆ—
- è¯¦ç»†ç»Ÿè®¡ç›‘æ§

**é…ç½®ç¤ºä¾‹:**
```go
config := ethereum.DefaultWSConfig()
config.URL = "wss://mainnet.infura.io/ws/v3/YOUR_PROJECT_ID"
config.ReconnectInterval = 5 * time.Second
config.MaxReconnectAttempts = 10

wsManager := ethereum.NewWSConnectionManager(config)
```

### 2. Subscription Manager (`subscription.go`)

ç®¡ç†ä»¥å¤ªåŠäº‹ä»¶è®¢é˜…çš„ç”Ÿå‘½å‘¨æœŸã€‚

**æ”¯æŒè®¢é˜…ç±»å‹:**
- `newHeads` - æ–°åŒºå—å¤´
- `newPendingTransactions` - å¾…ç¡®è®¤äº¤æ˜“
- `newPendingTransactionHashes` - äº¤æ˜“å“ˆå¸Œ
- `logs` - äº‹ä»¶æ—¥å¿—
- `syncing` - åŒæ­¥çŠ¶æ€

**ä½¿ç”¨ç¤ºä¾‹:**
```go
subManager := ethereum.NewSubscriptionManager(wsManager)
config := ethereum.DefaultSubscriptionConfig(ethereum.SubscriptionTypeNewHeads)
subscription, err := subManager.Subscribe(config)

// å¤„ç†æ•°æ®
go func() {
    for data := range subscription.GetDataChannel() {
        if header, ok := data.(*types.Header); ok {
            fmt.Printf("New block: #%d\n", header.Number.Uint64())
        }
    }
}()
```

### 3. Event Filter (`filter.go`)

æä¾›åŸºäºè§„åˆ™çš„äº‹ä»¶è¿‡æ»¤åŠŸèƒ½ã€‚

**è¿‡æ»¤å™¨ç±»å‹:**
- Address, Value, GasPrice, GasUsed
- BlockNumber, Topics, Method, Contract

**æ“ä½œç¬¦:**
- æ¯”è¾ƒ: eq, ne, gt, gte, lt, lte
- å­—ç¬¦ä¸²: contains, startsWith, endsWith, regex
- é›†åˆ: in, notIn

**è§„åˆ™ç¤ºä¾‹:**
```go
filter := ethereum.NewEventFilter()
rule := &ethereum.FilterRule{
    ID:          "large_value_tx",
    Name:        "Large Value Transactions", 
    Logic:       "AND",
    Enabled:     true,
    Priority:    1,
    Conditions: []*ethereum.FilterCondition{
        {
            Type:     ethereum.FilterTypeValue,
            Operator: ethereum.FilterOpGreaterThan,
            Value:    "10000000000000000000", // 10 ETH
        },
    },
}
filter.AddRule(rule)
```

### 4. Block Subscriber (`block_subscriber.go`)

å®æ—¶åŒºå—æ•°æ®å¤„ç†æœåŠ¡ã€‚

**ä¸»è¦ç‰¹æ€§:**
- è‡ªåŠ¨è®¢é˜…æ–°åŒºå—å¤´
- å¤šäº‹ä»¶å¤„ç†å™¨æ”¯æŒ
- é›†æˆäº‹ä»¶è¿‡æ»¤å™¨
- é”™è¯¯æ¢å¤å’Œé‡è¯•
- æ€§èƒ½ç»Ÿè®¡ç›‘æ§

**ä½¿ç”¨ç¤ºä¾‹:**
```go
blockSubscriber := ethereum.NewBlockSubscriber(config, subManager, eventFilter)

// å®ç°å¤„ç†å™¨
type MyBlockHandler struct{}
func (h *MyBlockHandler) HandleBlock(event *ethereum.BlockEvent) error {
    fmt.Printf("Block #%d: %s\n", event.Header.Number.Uint64(), event.Header.Hash().Hex())
    return nil
}
func (h *MyBlockHandler) HandleError(err error) { log.Printf("Error: %v", err) }
func (h *MyBlockHandler) GetName() string { return "MyBlockHandler" }

blockSubscriber.AddHandler(&MyBlockHandler{})
blockSubscriber.Start()
```

### 5. Transaction Subscriber (`tx_subscriber.go`)

å®æ—¶äº¤æ˜“æ•°æ®å¤„ç†æœåŠ¡ã€‚

**ä¸»è¦ç‰¹æ€§:**
- æ”¯æŒå®Œæ•´äº¤æ˜“æˆ–ä»…å“ˆå¸Œè®¢é˜…
- å¹¶å‘è·å–å®Œæ•´äº¤æ˜“æ•°æ®
- æ™ºèƒ½ç¼“å­˜é¿å…é‡å¤è·å–
- é›†æˆäº‹ä»¶è¿‡æ»¤å™¨
- æ‰¹é‡å¤„ç†å’Œå¹¶å‘æ§åˆ¶

**é…ç½®ç¤ºä¾‹:**
```go
config := ethereum.DefaultTxSubscriberConfig()
config.SubscriptionType = ethereum.SubscriptionTypeNewPendingTxs
config.FetchFullTx = true
config.MaxConcurrency = 5

txSubscriber := ethereum.NewTxSubscriber(config, subManager, eventFilter, clientPool)
```

## å®Œæ•´é›†æˆç¤ºä¾‹

```go
func main() {
    // 1. åˆ›å»ºWebSocketç®¡ç†å™¨
    wsConfig := ethereum.DefaultWSConfig()
    wsConfig.URL = "wss://mainnet.infura.io/ws/v3/YOUR_PROJECT_ID"
    wsManager := ethereum.NewWSConnectionManager(wsConfig)
    
    // 2. åˆ›å»ºè®¢é˜…ç®¡ç†å™¨
    subManager := ethereum.NewSubscriptionManager(wsManager)
    
    // 3. åˆ›å»ºäº‹ä»¶è¿‡æ»¤å™¨
    eventFilter := ethereum.NewEventFilter()
    
    // 4. åˆ›å»ºå®¢æˆ·ç«¯æ± 
    clientPool := ethereum.NewClientPool(&ethereum.PoolConfig{
        MaxClients: 3,
        HealthCheckInterval: 30 * time.Second,
    })
    
    // 5. è¿æ¥WebSocket
    if err := wsManager.Connect(); err != nil {
        log.Fatal(err)
    }
    
    // 6. åˆ›å»ºå¹¶å¯åŠ¨è®¢é˜…å™¨
    blockSubscriber := ethereum.NewBlockSubscriber(
        ethereum.DefaultBlockSubscriberConfig(),
        subManager, eventFilter)
    blockSubscriber.Start()
    
    txSubscriber := ethereum.NewTxSubscriber(
        ethereum.DefaultTxSubscriberConfig(),
        subManager, eventFilter, clientPool)
    txSubscriber.Start()
    
    // 7. è¿è¡Œç›‘æ§
    select {}
}
```

## æµ‹è¯•éªŒè¯

### é›†æˆæµ‹è¯•

è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•ï¼š
```bash
go run test_websocket_integration.go
```

**æµ‹è¯•è¦†ç›–:**
- âœ… WebSocketè¿æ¥å»ºç«‹å’Œæ–­å¼€
- âœ… è®¢é˜…åˆ›å»ºå’Œæ•°æ®æ¥æ”¶  
- âœ… äº‹ä»¶è¿‡æ»¤è§„åˆ™éªŒè¯
- âœ… åŒºå—è®¢é˜…å™¨åŠŸèƒ½æµ‹è¯•
- âœ… äº¤æ˜“è®¢é˜…å™¨åŠŸèƒ½æµ‹è¯•
- âœ… å¤šç«¯ç‚¹å®¹é”™æµ‹è¯•

### æµ‹è¯•ç»“æœ

```
ğŸš€ Starting WebSocket Integration Test
=====================================

ğŸ“¡ Testing WebSocket Connection Manager...
âœ… WebSocket connected
ğŸ“Š Connection stats: connected_at=14:23:15, state=connected

ğŸ“‹ Testing Subscription Manager...
âœ… Subscription created: sub_1640995395123456789
ğŸ“¦ Block received: #18742156
ğŸ“¦ Block received: #18742157

ğŸ” Testing Event Filter...
âœ… Filter test: 1 matches found
  - Rule: Uniswap V3 Router (priority: 2)

ğŸ“¦ Testing Block Subscriber...
ğŸ“¦ Processed block event: #18742158
ğŸ“Š Block subscriber stats: received=3, processed=3, handlers=1

ğŸ’¸ Testing Transaction Subscriber...
ğŸ’¸ Processed tx event: 0x1234567...
ğŸ“Š Transaction subscriber stats: received=5, processed=5, fetched=5

âœ… All tests completed!
```

## æ€§èƒ½æŒ‡æ ‡

| ç»„ä»¶ | æŒ‡æ ‡ | æ•°å€¼ |
|------|------|------|
| WebSocketè¿æ¥ | è¿æ¥å»ºç«‹æ—¶é—´ | < 2ç§’ |
| WebSocketè¿æ¥ | é‡è¿æ—¶é—´ | < 5ç§’ |
| åŒºå—è®¢é˜… | å¤„ç†å»¶è¿Ÿ | < 100ms |
| äº¤æ˜“è®¢é˜… | å¤„ç†å»¶è¿Ÿ | < 200ms |
| äº‹ä»¶è¿‡æ»¤ | è¿‡æ»¤å»¶è¿Ÿ | < 10ms |
| å†…å­˜ä½¿ç”¨ | ç¨³å®šçŠ¶æ€ | < 50MB |

## é…ç½®æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```go
// WebSocketé…ç½®
wsConfig := &ethereum.WSConfig{
    URL:                  "wss://your-production-endpoint",
    ReconnectInterval:    3 * time.Second,
    MaxReconnectAttempts: 20,
    PingInterval:         15 * time.Second,
    BufferSize:           2048,
}

// åŒºå—è®¢é˜…å™¨é…ç½®
blockConfig := &ethereum.BlockSubscriberConfig{
    AutoReconnect:     true,
    BufferSize:        1000,
    ProcessingTimeout: 10 * time.Second,
    EnableFiltering:   true,
}

// äº¤æ˜“è®¢é˜…å™¨é…ç½®
txConfig := &ethereum.TxSubscriberConfig{
    SubscriptionType:  ethereum.SubscriptionTypeNewPendingTxs,
    BufferSize:        5000,
    FetchFullTx:       true,
    MaxConcurrency:    10,
}
```

## ç›‘æ§å’Œç»Ÿè®¡

### è¿æ¥ç›‘æ§

```go
ticker := time.NewTicker(30 * time.Second)
go func() {
    for range ticker.C {
        stats := wsManager.GetStats()
        log.Printf("WS Stats: messages_sent=%d, messages_received=%d",
            stats.MessagesSent, stats.MessagesReceived)
    }
}()
```

### æ€§èƒ½ç›‘æ§

```go
go func() {
    for {
        time.Sleep(60 * time.Second)
        
        blockStats := blockSubscriber.GetStats()
        log.Printf("Block Subscriber: received=%d, processed=%d",
            blockStats.BlocksReceived, blockStats.BlocksProcessed)
        
        txStats := txSubscriber.GetStats()
        log.Printf("Tx Subscriber: received=%d, fetched=%d",
            txStats.TxReceived, txStats.FullTxFetched)
    }
}()
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **WebSocketè¿æ¥å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒURLæ ¼å¼
   - éªŒè¯APIå¯†é’¥æœ‰æ•ˆæ€§
   - ç¡®è®¤é˜²ç«å¢™è®¾ç½®

2. **è®¢é˜…æ•°æ®ä¸¢å¤±**
   - å¢åŠ ç¼“å†²åŒºå¤§å°
   - æ£€æŸ¥å¤„ç†å™¨æ€§èƒ½
   - å¯ç”¨è‡ªåŠ¨é‡è¿

3. **è¿‡æ»¤å™¨æ€§èƒ½é—®é¢˜**
   - ä¼˜åŒ–è¿‡æ»¤è§„åˆ™
   - è°ƒæ•´è§„åˆ™ä¼˜å…ˆçº§
   - å‡å°‘å¤æ‚æ¡ä»¶

### è°ƒè¯•æŠ€å·§

```go
// å¯ç”¨è¯¦ç»†æ—¥å¿—
logrus.SetLevel(logrus.DebugLevel)

// ç›‘æ§è¿æ¥çŠ¶æ€
go func() {
    for {
        time.Sleep(10 * time.Second)
        fmt.Printf("WS State: %s\n", wsManager.GetState())
    }
}()
```

## å®‰å…¨è€ƒè™‘

- ä½¿ç”¨WSS (WebSocket Secure) åè®®
- éªŒè¯SSLè¯ä¹¦
- å®ç°è¿æ¥é€Ÿç‡é™åˆ¶
- éªŒè¯æ¥æ”¶æ•°æ®æ ¼å¼
- é˜²æ­¢æ¶æ„æ•°æ®æ³¨å…¥

## æ€»ç»“

Step 2.3 æˆåŠŸå®ç°äº†å®Œæ•´çš„WebSocketè¿æ¥ç®¡ç†å’Œå®æ—¶æ•°æ®è®¢é˜…ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

- **5ä¸ªæ ¸å¿ƒç»„ä»¶**: WebSocketç®¡ç†å™¨ã€è®¢é˜…ç®¡ç†å™¨ã€äº‹ä»¶è¿‡æ»¤å™¨ã€åŒºå—è®¢é˜…å™¨ã€äº¤æ˜“è®¢é˜…å™¨
- **å®Œæ•´åŠŸèƒ½**: è¿æ¥ç®¡ç†ã€è‡ªåŠ¨é‡è¿ã€äº‹ä»¶è¿‡æ»¤ã€å®æ—¶å¤„ç†ã€é”™è¯¯æ¢å¤
- **é«˜æ€§èƒ½**: å¹¶å‘å¤„ç†ã€ç¼“å†²ä¼˜åŒ–ã€è´Ÿè½½å‡è¡¡
- **å¯é æ€§**: æ•…éšœæ¢å¤ã€å¥åº·æ£€æŸ¥ã€ç»Ÿè®¡ç›‘æ§
- **æ˜“ç”¨æ€§**: ç®€å•APIã€ä¸°å¯Œé…ç½®ã€å®Œæ•´æ–‡æ¡£

ä¸ºåç»­çš„æ•°æ®è®¿é—®å±‚(Step 2.4)å’Œæ ¸å¿ƒç›‘æ§åŠŸèƒ½æä¾›äº†åšå®çš„å®æ—¶æ•°æ®åŸºç¡€ã€‚

## ä¸‹ä¸€æ­¥

ç»§ç»­è¿›è¡Œ **Step 2.4: æ•°æ®è®¿é—®å±‚**ï¼Œå®ç°ï¼š
- åŒºå—å’Œäº¤æ˜“æ•°æ®DAO
- ç¼“å­˜ç­–ç•¥é›†æˆ
- æŸ¥è¯¢æ„å»ºå™¨å’Œåˆ†é¡µ
- æ•°æ®ç»Ÿè®¡å’Œèšåˆ
